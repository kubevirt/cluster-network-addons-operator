---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cluster-network-addons-operator
  namespace: {{.Namespace}}

{{.CNA.ClusterRoleString}}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-network-addons-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-network-addons-operator
subjects:
  - kind: ServiceAccount
    name: cluster-network-addons-operator
    namespace: {{.Namespace}}

{{.CNA.RoleString}}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cluster-network-addons-operator
  namespace: {{.Namespace}}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cluster-network-addons-operator
subjects:
  - kind: ServiceAccount
    name: cluster-network-addons-operator

{{.CNA.Deployment}}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cnao-allow-egress-to-dns
  namespace: {{.Namespace}}
spec:
  podSelector:
    matchLabels:
      name: cluster-network-addons-operator
  policyTypes:
    - Egress
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .ClusterDNSPlacement.Namespace }}
        podSelector:
          matchLabels:
            {{ .ClusterDNSPlacement.LabelKey }}: {{ .ClusterDNSPlacement.LabelValue }}
      ports:
        - protocol: TCP
          port: dns-tcp
        - protocol: UDP
          port: dns
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cnao-allow-egress-to-api-server
  namespace: {{.Namespace}}
spec:
  podSelector:
    matchLabels:
      name: cluster-network-addons-operator
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 6443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cnao-allow-ingress-to-metrics-endpoint
  namespace: {{.Namespace}}
spec:
  podSelector:
    matchLabels:
      name: cluster-network-addons-operator
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: metrics
